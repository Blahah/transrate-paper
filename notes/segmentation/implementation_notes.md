# segmentation score component development notes

## implementation

- problems with Liu et al. paper
- after fixing maths, got working implementation for 0 or 1 changepoints
- couldn't get recursive algorithm to work, but we don't need it as >1 changepoints get captured in the probability for 1
- available in the Ruby gem 'Carpel'

## examining utility of the segmentation score component

I took a BCF file generated by transrate for the yeast-trinity assembly and parsed the first 1000 contigs in ruby to get an array of coverage for each contig. I then ran the segmentation algorithm on it to output the most likely number of change-points in the coverage of each contig, along with the probability associated with the result.

This predicted that only 1.9% of the contigs has at least one change-point. I examined the 19 contigs found to have changepoints and discovered that `bcftools view` is capping the coverage output to 283 for each base.

Also, after blasting a couple of the 19 contigs, it became clear that at least some of them were just multiple isoforms that had segmentation because for part of the transcript, reads were mapping to it and its siblings, while for the rest they were only mapping to it.

## using eXpress to assign reads

To solve the multiple isoform problem I aligned the reads to the assembly with bowtie2 and used eXpress to calculate probabilities for multimapping reads, and then outputted a single alignment per fragment.

The segmentation algorithm appears to be working well based on a quick visual inspection.

### Next steps

- pick out a sample of the segmented contigs and examine them using blast, etc.
- do a simulation to determine efficacy

## fixing bcftools view

note: maybe the bcftools view limit thing doesn't need to be fixed... it seems like bcftools just scales the coverage within each coverage to have a maximum of 283 if it goes above that

To try to solve the bcftools view limit I manuall ran an mpileup command, and saved the results to file rather than piping to BCFtools.

```bash
$ samtools mpileup -f /tmp/cmb211/transrate-paper/data/yeast/assembly/corset_extra_data/Yeast-Trinity/Trinity.fasta -B -q0 -Q0 -I -u hits.1.samp.sorted.bam > trinity_yeast.mpileup
```

relevant files are in directory on node5:

```
/tmp/rds45/transrate_paper
```

note that new v1.1 of bcftools has been installed in `~/apps/`, but the samtools equivalent version also needs to be installed.

Next steps
